{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Consultation Rooms</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='{% static "main.css" %}'>
    <style>
        select {
    margin: 10px;
    font-size: 40px;
    font-weight: 700;
    width: auto;


        }
        select:focus {
            min-width: 150px;
            width: auto;
        }
    </style>
</head>
<body>

<h2 class="bolder header m0-auto" style="text-align:center;">590 5<sup>th</sup> Avenue Office Suite</h2>
<div class="border-container">
    <form action="" method="post"  name="consultation-form">
    <div class="table info">
        {% for room in object_list %}
        {% if forloop.first %}
        <div class="table-cell title noRborder" style="outline: transparent;">
            &nbsp;
        </div>
        {% endif %}

        <div class="table-cell title noRborder" style="outline: transparent;">
            <h3 class="bolder header m0-auto ">
                {{room}}
            </h3>
         <input type="hidden" name="hidden_{{room.id}}" value="{{room.id}}" class="hidden-form-field">
        </div>
        <div class="table-cell">
            <p>
                <select name="doctor-{{room.id}}" class="form-field" data-room-id={{room.id}} onchange="submitForm()">
                    {% for doctor in doctors %}
                    <option value="{{doctor.id}}"
                            {% if room.doctor == doctor %} selected="selected" {% endif %}>
                        {{ doctor.name }}
                    </option>
                    {% endfor %}
                </select>
            </p>
        </div>
        <div class="table-cell">
            <p>
                <select name="room_status-{{room.id}}" class="form-field" data-room-id={{room.id}} onchange="submitForm()">
                    {% for room_status in room_statuses %}
                    <option value="{{room_status.id}}"
                            {% if room.room_status == room_status %} selected="selected" {% endif %}>
                        {{ room_status.name }}
                    </option>
                    {% endfor %}
                </select>
            </p>
        </div>
        <div class="table-cell noRborder">
                <textarea id="room_text" name="room_text-{{room.id}}" rows="4" cols="50" class="form-field" data-room-id={{room.id}} onchange="submitForm()">
                {{room.room_text}}
                </textarea>
        </div>
        {% endfor %}

    </div>
    </form>
</div>
</body>
<script type="text/javascript">
let intervalID = window.setInterval(checkData, 5000);
    document.addEventListener("DOMContentLoaded", function() {




});

async function constructPayload(){
    let payload = {}
    
let hiddenFields = document.querySelectorAll("[class=hidden-form-field]")
for (i = 0; i < hiddenFields.length; ++i) {
    payload[hiddenFields[i].value] = {}
}



for (const key in payload) {

    let roomId = `[data-room-id="${key}"]`;
let fields =document.querySelectorAll(roomId);
    for (i = 0; i < fields.length; ++i) {
        let fieldParts = fields[i].name.split("-");
        let keyName = fieldParts[0];
        let fieldValue = fields[i].value;
        payload[key][keyName] =  fieldValue;
    }
}
console.log(payload)
return payload;



}
async function submitForm(){
    payload = await constructPayload();
    const response = await fetch('http://localhost:8000/save-data/', {
        method: 'POST',
        body: JSON.stringify(payload)  , 
        headers: {
          'Content-Type': 'application/json'
        }
      });
      const jsonResponse = await response.json(); 
      console.log(jsonResponse);
  }
async function checkData(){
    const response = await fetch(`http://localhost:8000/save-data/?key=has_consulting_rooms_changed`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      const jsonResponse = await response.json();
      if(jsonResponse.data_changed) {
        location.reload();

      }
  }

</script>
</html>